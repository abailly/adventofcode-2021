use aoc2021::kruskal::min_spanning_tree;
use core::u64::MAX;
use std::collections::HashMap;
use std::collections::HashSet;
use std::env;
use std::process;
use std::u64::MIN;

type Pos = [i64; 3];

#[derive(Debug, PartialEq, Eq, PartialOrd, Ord, Clone)]
struct Scanner {
    id: u8,
    beacons: Vec<Pos>,
}

#[derive(Debug, PartialEq, Eq, PartialOrd, Ord, Clone)]
struct Matching {
    from: usize,
    to: usize,
    count: usize,
    matching: Vec<((usize, usize), (usize, usize))>,
}

fn scanners() -> Vec<Scanner> {
    return vec![
        Scanner {
            id: 0,
            beacons: vec![
                [579, 799, 416],
                [48, 82, -27],
                [474, -502, 534],
                [652, -594, 511],
                [-609, 574, -469],
                [352, -544, -666],
                [-780, 740, 353],
                [-33, -102, -83],
                [384, -640, -624],
                [470, -559, 544],
                [468, 864, 533],
                [670, 759, -677],
                [-700, 873, 335],
                [-747, -486, -412],
                [349, -584, -782],
                [-382, -890, 249],
                [-567, 658, -522],
                [-689, 659, -426],
                [531, 820, -584],
                [-738, -569, -457],
                [-369, -772, 414],
                [-816, 800, 310],
                [601, 763, -473],
                [355, 790, 421],
                [-629, -538, -431],
                [-387, -903, 381],
            ],
        },
        Scanner {
            id: 1,
            beacons: vec![
                [961, 715, -541],
                [-390, 653, -337],
                [475, -505, -519],
                [-398, 393, 554],
                [-543, -651, 892],
                [917, -691, 745],
                [-333, 512, 638],
                [-447, -609, 924],
                [949, 600, -504],
                [-487, -493, 927],
                [959, 652, 536],
                [860, -802, 675],
                [425, -583, -486],
                [31, 89, -38],
                [856, -598, 606],
                [-729, -629, -505],
                [-381, 635, -466],
                [-728, -658, -697],
                [940, 447, 580],
                [423, -556, -430],
                [921, 566, 529],
                [-385, 763, -451],
                [82, -46, 86],
                [863, 628, -559],
                [-792, -638, -728],
                [-441, 535, 654],
            ],
        },
        Scanner {
            id: 2,
            beacons: vec![
                [-619, -740, -444],
                [284, 732, -285],
                [349, 769, -397],
                [-800, 371, 856],
                [-154, -142, 35],
                [-588, -753, -593],
                [433, -771, 646],
                [426, 648, 604],
                [-469, -701, 964],
                [-436, -703, 873],
                [-831, 445, 878],
                [-68, -35, 148],
                [433, -910, 547],
                [321, 677, -474],
                [658, -831, -735],
                [-708, 471, -612],
                [532, 743, 654],
                [-599, -758, 926],
                [543, -753, -648],
                [445, -815, -781],
                [-682, -685, -597],
                [491, -773, 545],
                [-814, 389, -621],
                [-712, 458, 817],
                [-726, 309, -547],
                [422, 838, 592],
            ],
        },
        Scanner {
            id: 3,
            beacons: vec![
                [-742, 640, 493],
                [468, 610, -347],
                [-656, 680, 388],
                [533, 814, 631],
                [-501, 744, -596],
                [472, -555, -383],
                [-55, 12, 40],
                [603, -399, 668],
                [-422, 891, -618],
                [-505, -699, 597],
                [-520, 646, 478],
                [-523, -607, -421],
                [-487, -491, 600],
                [479, -501, 677],
                [475, 661, -559],
                [428, 770, 510],
                [-526, -596, -325],
                [443, -605, -422],
                [374, -553, -286],
                [548, -425, 783],
                [-570, 841, -566],
                [-401, -666, 575],
                [605, 756, 519],
                [469, 566, -488],
                [-494, -573, -565],
            ],
        },
        Scanner {
            id: 4,
            beacons: vec![
                [-24, -9, -13],
                [693, 825, -612],
                [-659, 674, 730],
                [726, 696, 493],
                [-602, -470, 716],
                [-548, 804, -616],
                [-273, -440, -429],
                [755, 920, -722],
                [591, -810, 463],
                [104, 132, 31],
                [-798, 656, 824],
                [701, -689, -711],
                [-566, -637, 674],
                [800, -828, -711],
                [901, 636, 510],
                [-548, -422, 677],
                [592, -714, 585],
                [-775, 678, 794],
                [-336, -418, -360],
                [906, 716, 416],
                [-738, 825, -594],
                [-360, -472, -355],
                [-647, 851, -605],
                [802, -691, -653],
                [743, 730, -718],
                [676, -767, 543],
            ],
        },
        Scanner {
            id: 5,
            beacons: vec![
                [295, -829, -370],
                [-646, -497, -795],
                [785, -566, 682],
                [331, -823, -362],
                [396, 624, -653],
                [-345, 390, -837],
                [-854, -521, 625],
                [-776, -569, 671],
                [-719, 302, 694],
                [775, -608, 710],
                [618, 434, 807],
                [613, -547, 645],
                [-691, -468, -758],
                [-857, 329, 748],
                [366, 768, -662],
                [-46, -127, -7],
                [-368, 546, -822],
                [-855, -613, 723],
                [477, -938, -370],
                [727, 347, 755],
                [803, 431, 840],
                [-390, 421, -837],
                [-915, 322, 743],
                [-713, -449, -683],
                [322, 664, -548],
            ],
        },
        Scanner {
            id: 6,
            beacons: vec![
                [-478, -795, -399],
                [636, 601, 800],
                [475, 790, -480],
                [399, -509, 961],
                [48, 51, 76],
                [-372, 687, 518],
                [429, -773, -421],
                [-854, 749, -409],
                [-751, 809, -318],
                [379, -786, -305],
                [-764, -417, 427],
                [-712, -535, 446],
                [552, -546, 960],
                [-809, 832, -531],
                [653, 710, 892],
                [483, 781, -545],
                [-104, 95, 187],
                [378, -509, 931],
                [-505, 589, 580],
                [-681, -426, 472],
                [499, 783, -725],
                [-347, -777, -366],
                [452, -886, -397],
                [-360, -782, -234],
                [720, 662, 828],
                [-418, 474, 502],
            ],
        },
        Scanner {
            id: 7,
            beacons: vec![
                [-747, -527, -295],
                [-383, 523, 528],
                [722, -666, 942],
                [622, -640, -526],
                [-722, -449, -374],
                [822, -614, 982],
                [531, 486, 601],
                [-473, -615, 807],
                [658, -592, -519],
                [546, 512, -555],
                [801, -857, 967],
                [-487, 406, -646],
                [-20, -36, 160],
                [-491, 411, -601],
                [596, 468, 439],
                [550, 606, -623],
                [-705, -445, -317],
                [636, -516, -380],
                [699, 575, -610],
                [-472, -687, 821],
                [522, 380, 519],
                [-563, 527, 518],
                [-336, 449, -620],
                [-74, -172, 0],
                [-502, -611, 738],
                [-473, 453, 641],
            ],
        },
        Scanner {
            id: 8,
            beacons: vec![
                [-325, 277, 621],
                [-346, 432, 631],
                [648, -738, 463],
                [-284, -886, -509],
                [610, -583, -878],
                [429, 537, 390],
                [-366, -908, -467],
                [661, -654, 541],
                [567, -557, -727],
                [605, -763, 488],
                [-379, -707, 832],
                [583, 609, 339],
                [823, 713, -542],
                [888, 705, -461],
                [-262, 393, -504],
                [458, 674, 373],
                [-329, -650, 646],
                [572, -602, -723],
                [-237, 503, -467],
                [-288, -829, -492],
                [-5, 6, -132],
                [-386, 307, 509],
                [-383, -599, 733],
                [99, -170, -55],
                [-249, 384, -440],
                [830, 694, -667],
            ],
        },
        Scanner {
            id: 9,
            beacons: vec![
                [597, -475, -339],
                [821, 675, 845],
                [-364, -312, 543],
                [414, 576, -313],
                [743, 721, 797],
                [-328, -320, 537],
                [-749, 800, -693],
                [386, 653, -405],
                [-661, 726, -773],
                [-95, 72, 62],
                [-643, 791, -611],
                [-647, -638, -624],
                [822, 773, 753],
                [-735, -677, -711],
                [613, -745, 869],
                [658, -708, 898],
                [487, -413, -244],
                [491, -425, -434],
                [-646, 695, 819],
                [349, 464, -350],
                [-510, -320, 428],
                [-818, 732, 800],
                [680, -633, 917],
                [-766, -699, -637],
                [74, 149, -8],
                [-808, 760, 758],
            ],
        },
        Scanner {
            id: 10,
            beacons: vec![
                [671, -555, -655],
                [672, 548, 433],
                [-684, 363, -477],
                [628, 600, 354],
                [720, 502, 355],
                [792, -806, 496],
                [397, 393, -396],
                [-438, 403, 762],
                [-573, -435, -449],
                [-475, 291, 827],
                [397, 400, -473],
                [434, 477, -433],
                [-559, -598, 685],
                [-464, -648, 579],
                [-625, 390, -456],
                [657, -513, -539],
                [773, -881, 518],
                [-653, -440, -543],
                [744, -918, 563],
                [-672, 386, -603],
                [-147, -172, 17],
                [647, -507, -645],
                [-369, -586, 689],
                [-530, 480, 790],
                [-593, -615, -526],
                [-35, -50, -86],
            ],
        },
        Scanner {
            id: 11,
            beacons: vec![
                [-708, -978, -663],
                [715, -781, -742],
                [680, 759, -622],
                [-262, 303, 742],
                [819, 750, -718],
                [-406, 333, 733],
                [881, -642, 685],
                [-701, -920, -668],
                [654, -831, -823],
                [557, 760, 713],
                [565, 725, 753],
                [940, -709, 735],
                [-683, 664, -675],
                [933, -652, 865],
                [162, -1, 80],
                [-484, -431, 902],
                [-599, 740, -760],
                [-596, 555, -727],
                [763, -827, -746],
                [-366, 259, 628],
                [-609, -453, 917],
                [-728, -782, -614],
                [-640, -408, 917],
                [463, 792, 860],
                [30, -171, -39],
                [742, 714, -656],
            ],
        },
        Scanner {
            id: 12,
            beacons: vec![
                [-557, -594, -751],
                [535, -288, -328],
                [522, -780, 851],
                [577, 462, -599],
                [-378, 644, 873],
                [506, -435, -371],
                [562, -830, 712],
                [490, 514, -708],
                [-404, 624, -594],
                [620, -862, 805],
                [30, -32, -49],
                [-485, -641, -711],
                [-470, 546, 874],
                [445, 575, 738],
                [442, -439, -322],
                [-423, 587, -766],
                [-722, -561, 777],
                [-794, -556, 932],
                [472, 521, 876],
                [-426, 598, 795],
                [-666, -473, 931],
                [465, 526, 934],
                [-41, 29, 133],
                [-673, -676, -778],
                [-465, 559, -756],
                [574, 429, -784],
            ],
        },
        Scanner {
            id: 13,
            beacons: vec![
                [-512, -780, -383],
                [-634, -328, 271],
                [850, 517, 723],
                [409, -606, 298],
                [-639, -724, -396],
                [380, -651, 335],
                [100, -55, 35],
                [-752, 362, 545],
                [735, 371, 731],
                [739, 589, -529],
                [-411, 665, -757],
                [656, -371, -623],
                [827, 524, -467],
                [708, -458, -468],
                [833, 537, -431],
                [-488, 714, -796],
                [-610, -752, -415],
                [749, -364, -620],
                [-509, -350, 256],
                [-478, -305, 256],
                [-856, 406, 431],
                [361, -673, 410],
                [741, 335, 723],
                [-436, 839, -789],
                [22, 58, -107],
                [-712, 436, 440],
            ],
        },
        Scanner {
            id: 14,
            beacons: vec![
                [-460, 675, -680],
                [431, -518, -720],
                [410, -453, -630],
                [546, 395, -372],
                [-809, -922, -637],
                [-476, -447, 567],
                [-385, 609, -563],
                [-679, -919, -628],
                [496, 378, -277],
                [481, -504, 704],
                [-668, -866, -537],
                [401, -490, -849],
                [-432, 672, -630],
                [606, -464, 582],
                [711, 311, 823],
                [-589, 487, 725],
                [848, 340, 840],
                [2, 45, 75],
                [-564, 530, 750],
                [559, 334, -368],
                [783, 465, 874],
                [-533, -497, 381],
                [-480, 543, 672],
                [-425, -501, 480],
                [451, -443, 592],
                [95, -118, 129],
            ],
        },
        Scanner {
            id: 15,
            beacons: vec![
                [901, -715, 774],
                [-447, 800, -713],
                [-499, -598, 656],
                [-530, 755, -704],
                [613, 743, -575],
                [-57, -132, 9],
                [863, -629, 781],
                [859, 628, 565],
                [383, -740, -702],
                [563, -720, -625],
                [698, 786, -655],
                [388, -660, -608],
                [802, 739, 635],
                [-499, 781, -595],
                [-391, -575, 672],
                [-415, -629, -674],
                [-438, -641, -548],
                [697, 690, -533],
                [-545, 430, 383],
                [-442, -688, -695],
                [882, -510, 730],
                [-505, 546, 386],
                [-456, -456, 756],
                [798, 535, 704],
                [100, -5, 81],
                [-601, 588, 418],
            ],
        },
        Scanner {
            id: 16,
            beacons: vec![
                [645, -660, -815],
                [686, -400, 877],
                [-788, 541, -551],
                [-582, -777, -582],
                [549, -417, 906],
                [-726, -490, 687],
                [0, 107, 10],
                [-169, -72, 58],
                [621, -366, 752],
                [-751, -515, 730],
                [800, -659, -703],
                [-545, 700, 768],
                [725, 515, 512],
                [-482, -755, -724],
                [-571, 851, 725],
                [-816, 457, -490],
                [737, 678, -369],
                [557, 694, -371],
                [-648, -739, -637],
                [717, 434, 447],
                [-642, -568, 674],
                [-880, 524, -442],
                [585, -617, -730],
                [706, 640, 505],
                [492, 702, -362],
                [-590, 696, 763],
            ],
        },
        Scanner {
            id: 17,
            beacons: vec![
                [-786, 419, -780],
                [580, 542, 522],
                [-753, -461, 678],
                [-671, 506, -702],
                [660, -476, -725],
                [-723, -515, 665],
                [491, 710, -689],
                [-659, -635, -482],
                [460, 561, -702],
                [4, 11, -37],
                [-133, 118, 35],
                [-477, 757, 820],
                [-550, -652, -390],
                [-828, -586, 678],
                [-449, 680, 728],
                [554, 557, -634],
                [598, 607, 360],
                [539, -552, 439],
                [686, 533, 440],
                [-412, 869, 783],
                [617, -325, -699],
                [543, -372, 449],
                [613, -462, 562],
                [-598, -719, -454],
                [-573, 373, -764],
                [655, -480, -680],
            ],
        },
        Scanner {
            id: 18,
            beacons: vec![
                [-626, 741, 779],
                [-621, 839, 736],
                [870, -429, 299],
                [-329, -456, -530],
                [-481, -415, -436],
                [474, -784, -723],
                [769, 358, -552],
                [-484, -508, -443],
                [862, -314, 445],
                [72, 37, -49],
                [707, 453, -662],
                [-564, 805, 649],
                [862, -423, 263],
                [-328, -337, 452],
                [757, 548, -556],
                [437, -755, -678],
                [544, 738, 582],
                [-292, -331, 465],
                [483, 751, 701],
                [-633, 427, -669],
                [-390, -425, 517],
                [505, 825, 670],
                [-724, 453, -680],
                [-534, 474, -658],
                [549, -803, -745],
            ],
        },
        Scanner {
            id: 19,
            beacons: vec![
                [885, -364, -767],
                [-758, -757, -795],
                [-620, 501, 549],
                [-808, 378, -727],
                [-652, -436, 692],
                [-654, 530, 693],
                [563, -461, 767],
                [-36, -26, 43],
                [-602, -465, 731],
                [-643, 533, 789],
                [754, -346, -734],
                [81, 100, -56],
                [697, 508, 518],
                [614, -468, 555],
                [541, 493, -604],
                [-818, -793, -838],
                [484, 497, -614],
                [872, -359, -899],
                [-882, 491, -615],
                [-891, -677, -813],
                [519, -462, 626],
                [-817, 602, -732],
                [844, 429, 496],
                [576, 675, -637],
                [-600, -367, 828],
                [794, 577, 548],
            ],
        },
        Scanner {
            id: 20,
            beacons: vec![
                [521, 799, 641],
                [-814, -478, 803],
                [564, 734, -498],
                [-816, -536, 666],
                [-505, 755, -478],
                [416, 854, 546],
                [-715, -478, 664],
                [626, 864, -562],
                [446, 818, 519],
                [346, -834, 447],
                [322, -829, 393],
                [633, -584, -876],
                [-483, 786, -552],
                [-488, 391, 596],
                [724, -595, -850],
                [-397, 424, 594],
                [534, -573, -829],
                [621, 821, -464],
                [-544, 667, -565],
                [-757, -471, -755],
                [-47, 63, -74],
                [259, -760, 415],
                [-707, -577, -850],
                [-435, 554, 651],
                [-769, -467, -945],
            ],
        },
        Scanner {
            id: 21,
            beacons: vec![
                [693, -762, -734],
                [616, 828, 628],
                [-684, -626, 636],
                [-595, 479, -482],
                [-383, 525, -446],
                [674, -607, -772],
                [-568, -625, -730],
                [-392, 572, 557],
                [782, 844, 715],
                [682, 866, 573],
                [-445, -535, -656],
                [-363, 646, 506],
                [448, -368, 481],
                [56, 54, 26],
                [-671, -572, 606],
                [-72, 160, -43],
                [513, 604, -739],
                [538, 579, -696],
                [476, -452, 542],
                [-684, -501, 711],
                [384, -435, 433],
                [-455, -715, -660],
                [-471, 488, -412],
                [622, 657, -683],
                [-315, 512, 408],
                [719, -611, -777],
            ],
        },
        Scanner {
            id: 22,
            beacons: vec![
                [-426, -460, -817],
                [430, -548, 757],
                [17, -21, 65],
                [645, -446, -810],
                [-502, -376, -732],
                [702, -493, -691],
                [312, 721, -517],
                [477, -544, 865],
                [283, -543, 859],
                [-616, 518, -622],
                [676, -492, -734],
                [332, 738, -554],
                [-96, 88, -105],
                [-863, -797, 685],
                [-934, 800, 393],
                [-454, 579, -687],
                [498, 874, 776],
                [-752, 909, 393],
                [-611, -463, -784],
                [473, 807, 749],
                [535, 829, 715],
                [-898, 794, 385],
                [369, 646, -663],
                [-444, 537, -659],
                [-907, -693, 571],
                [-833, -653, 676],
            ],
        },
        Scanner {
            id: 23,
            beacons: vec![
                [614, 503, 499],
                [-741, -573, -430],
                [666, 496, -326],
                [586, 590, -331],
                [-874, 485, 504],
                [70, 134, -24],
                [-764, 665, -640],
                [709, -743, 589],
                [-855, 603, 556],
                [-860, 543, -641],
                [-739, -631, -531],
                [680, -638, -489],
                [-799, -406, 850],
                [870, -642, -477],
                [-67, -30, 81],
                [801, -715, 512],
                [-878, -631, -432],
                [-783, -619, 896],
                [764, -780, 400],
                [567, 650, 495],
                [-829, 494, 587],
                [555, 524, 472],
                [-817, 623, -556],
                [646, 573, -506],
                [775, -532, -539],
                [-721, -521, 763],
            ],
        },
        Scanner {
            id: 24,
            beacons: vec![
                [-804, 350, 366],
                [456, -494, -642],
                [363, -619, 389],
                [-411, -594, 552],
                [261, 606, 745],
                [284, 599, -445],
                [341, -681, 423],
                [372, 534, -507],
                [278, 586, -409],
                [-878, 381, 388],
                [-1, -117, 40],
                [-791, 469, 427],
                [-127, 5, -73],
                [-670, -495, -397],
                [435, -446, -785],
                [543, -509, -828],
                [-403, -518, 594],
                [-734, -428, -464],
                [296, -644, 362],
                [-858, 402, -681],
                [376, 752, 753],
                [-849, -457, -445],
                [-892, 315, -738],
                [370, 788, 745],
                [-794, 272, -743],
                [-418, -406, 604],
            ],
        },
        Scanner {
            id: 25,
            beacons: vec![
                [86, 149, -150],
                [-572, -670, -518],
                [748, -704, -522],
                [569, -536, 361],
                [-723, -522, 310],
                [563, 566, -778],
                [-419, 589, 553],
                [-665, -309, 333],
                [-597, -464, -470],
                [829, -696, -457],
                [739, 901, 432],
                [806, 837, 480],
                [561, -471, 352],
                [-628, -622, -575],
                [722, 809, 541],
                [-623, 602, -609],
                [585, -716, 359],
                [623, -685, -515],
                [-470, 657, -672],
                [-474, 589, -578],
                [412, 592, -735],
                [-286, 527, 455],
                [1, 56, 27],
                [567, 611, -773],
                [-332, 511, 668],
                [-768, -400, 393],
            ],
        },
    ];
}

/// compute distance within 2 points
/// 2 keep things in integer realm, we don't compute square root
fn distance(x: Pos, y: Pos) -> u64 {
    ((x[1] - y[1]) * (x[1] - y[1]) + (x[0] - y[0]) * (x[0] - y[0]) + (x[2] - y[2]) * (x[2] - y[2]))
        as u64
}
fn distanceL1(x: Pos, y: Pos) -> u64 {
    ((x[1] - y[1]).abs() + (x[0] - y[0]).abs() + (x[2] - y[2]).abs()) as u64
}

/// Build a matrix of distances between all beacons in the vector
/// Only builds upper triangular matrice
fn compute_distances(pos: &Vec<Pos>) -> Vec<Vec<u64>> {
    let mut res = vec![];
    for j in 0..pos.len() {
        let mut new_row = Vec::with_capacity(pos.len());
        new_row.resize(pos.len(), 0);
        res.push(new_row);
        for i in j + 1..pos.len() {
            res[j][i] = distance(pos[i], pos[j]);
        }
    }
    res
}

/// Given a pair of distance matrices, compute a list of pairs of beacons which have
/// identical distances in both matrices
fn matching_distances(
    d1: &Vec<Vec<u64>>,
    d2: &Vec<Vec<u64>>,
) -> Vec<((usize, usize), (usize, usize))> {
    let mut res = vec![];
    for j in 0..d1.len() {
        for i in j + 1..d1.len() {
            for l in 0..d2.len() {
                for k in l + 1..d2.len() {
                    if d1[j][i] == d2[l][k] {
                        res.push(((i, j), (k, l)));
                    }
                }
            }
        }
    }
    res
}

/// Compute Matching for each pair of scanners
/// Returns the list of non-zero matchings ordered by highest number of matchings
/// so that "more compatible" scanner pairs are listed first
fn compute_matchings(scans: &Vec<Scanner>) -> Vec<Matching> {
    let dists: Vec<Vec<Vec<u64>>> = scans
        .iter()
        .map(|sc| compute_distances(&sc.beacons))
        .collect();
    let mut matchings = vec![];
    for j in 0..dists.len() {
        for i in j + 1..dists.len() {
            let matching = matching_distances(&dists[j], &dists[i]);
            if matching.len() > 0 {
                matchings.push(Matching {
                    from: j,
                    to: i,
                    count: matching.len(),
                    matching,
                });
            };
        }
    }
    matchings.sort_by(|m1, m2| m2.matching.len().cmp(&m1.matching.len()));
    matchings
}

fn compute_matching_beacons(matching: &Matching) -> Vec<(usize, usize)> {
    let mut pairs = vec![];
    for m in &matching.matching {
        pairs.push((m.0 .0, m.1 .0));
        pairs.push((m.0 .0, m.1 .1));
        pairs.push((m.0 .1, m.1 .0));
        pairs.push((m.0 .1, m.1 .1));
    }

    pairs.sort();

    let mut most_frequent: HashMap<(usize, usize), u8> = HashMap::new();
    for p in pairs {
        match most_frequent.get_mut(&p) {
            Some(count) => *count += 1,
            None => {
                most_frequent.insert(p, 1);
                ()
            }
        }
    }
    most_frequent
        .iter()
        .filter(|&(k, v)| *v > 1)
        .map(|(k, _)| *k)
        .collect()
}

fn minus(a: Pos, b: Pos) -> Pos {
    [a[0] - b[0], a[1] - b[1], a[2] - b[2]]
}

fn plus(a: Pos, b: Pos) -> Pos {
    [a[0] + b[0], a[1] + b[1], a[2] + b[2]]
}

fn mult(a: Vec<Pos>, b: Vec<Pos>) -> Vec<Pos> {
    let mut rot = vec![];
    for j in 0..3 {
        let mut pos = [0; 3];
        for i in 0..3 {
            let mut res = 0;
            for k in 0..3 {
                res += a[j][k] * b[k][i];
            }
            pos[i] = res;
        }
        rot.push(pos);
    }
    println!("= {:?}", rot);
    rot
}

/// From https://stackoverflow.com/questions/33190042/how-to-calculate-all-24-rotations-of-3d-array
/// Compute a list of all rotations of a cube, there are 24 of them
fn define_all_rotations() -> Vec<Vec<Pos>> {
    let fam_a = vec![
        vec![[1, 0, 0], [0, 1, 0], [0, 0, 1]],
        vec![[0, 1, 0], [0, 0, 1], [1, 0, 0]],
        vec![[0, 0, 1], [1, 0, 0], [0, 1, 0]],
    ];

    let fam_b = vec![
        vec![[1, 0, 0], [0, 1, 0], [0, 0, 1]],
        vec![[-1, 0, 0], [0, -1, 0], [0, 0, 1]],
        vec![[-1, 0, 0], [0, 1, 0], [0, 0, -1]],
        vec![[1, 0, 0], [0, -1, 0], [0, 0, -1]],
    ];

    let fam_c = vec![
        vec![[1, 0, 0], [0, 1, 0], [0, 0, 1]],
        vec![[0, 0, -1], [0, -1, 0], [-1, 0, 0]],
    ];

    let mut res = vec![];
    for a in &fam_a {
        for b in &fam_b {
            for c in &fam_c {
                let rot = mult(mult(a.to_vec(), b.to_vec()), c.to_vec());
                res.push(rot);
            }
        }
    }
    res
}

type Rotation = [[i64; 3]; 3];

trait Rotate {
    fn rotate(&self, pos: Pos) -> Pos;
}

impl Rotate for Rotation {
    fn rotate(&self, pos: Pos) -> Pos {
        let mut res = [0; 3];
        for j in 0..3 {
            for i in 0..3 {
                res[j] += pos[j] * self[i][j];
            }
        }
        res
    }
}

static ALL_ROTATIONS: [[[i64; 3]; 3]; 24] = [
    [[1, 0, 0], [0, 1, 0], [0, 0, 1]],
    [[0, 0, -1], [0, -1, 0], [-1, 0, 0]],
    [[-1, 0, 0], [0, -1, 0], [0, 0, 1]],
    [[0, 0, 1], [0, 1, 0], [-1, 0, 0]],
    [[-1, 0, 0], [0, 1, 0], [0, 0, -1]],
    [[0, 0, 1], [0, -1, 0], [1, 0, 0]],
    [[1, 0, 0], [0, -1, 0], [0, 0, -1]],
    [[0, 0, -1], [0, 1, 0], [1, 0, 0]],
    [[0, 1, 0], [0, 0, 1], [1, 0, 0]],
    [[0, -1, 0], [-1, 0, 0], [0, 0, -1]],
    [[0, -1, 0], [0, 0, 1], [-1, 0, 0]],
    [[0, 1, 0], [-1, 0, 0], [0, 0, 1]],
    [[0, 1, 0], [0, 0, -1], [-1, 0, 0]],
    [[0, -1, 0], [1, 0, 0], [0, 0, 1]],
    [[0, -1, 0], [0, 0, -1], [1, 0, 0]],
    [[0, 1, 0], [1, 0, 0], [0, 0, -1]],
    [[0, 0, 1], [1, 0, 0], [0, 1, 0]],
    [[-1, 0, 0], [0, 0, -1], [0, -1, 0]],
    [[0, 0, 1], [-1, 0, 0], [0, -1, 0]],
    [[-1, 0, 0], [0, 0, 1], [0, 1, 0]],
    [[0, 0, -1], [-1, 0, 0], [0, 1, 0]],
    [[1, 0, 0], [0, 0, 1], [0, -1, 0]],
    [[0, 0, -1], [1, 0, 0], [0, -1, 0]],
    [[1, 0, 0], [0, 0, -1], [0, 1, 0]],
];

/// Transform all points given by the given rotation
fn apply_rotation(a: &Vec<Pos>, rotation: Rotation) -> Vec<Pos> {
    a.iter().map(|p| rotation.rotate(*p)).collect()
}

/// Assuming the points are centered at the same location, compute the rotation
/// of b that maximises the number of equal points.
fn compute_rotation(a: &Vec<Pos>, b: &Vec<Pos>) -> Rotation {
    let mut minimum = MAX;
    let mut best_rot = 0;
    for r in 0..24 {
        let mut dists = 0;
        let rotated = apply_rotation(b, ALL_ROTATIONS[r]);
        for j in 0..a.len() {
            let dist = distance(a[j], rotated[j]);
            dists += dist;
        }
        if dists <= minimum {
            minimum = dists;
            best_rot = r;
        }
    }
    ALL_ROTATIONS[best_rot]
}

fn transform_scanner(sc: &Scanner, xform: Option<(Rotation, Pos)>) -> Scanner {
    match xform {
        Some((rot, trans)) => {
            let beacons = sc
                .beacons
                .iter()
                .map(|b| plus(rot.rotate(*b), trans))
                .collect();
            Scanner { id: sc.id, beacons }
        }
        None => Scanner {
            id: sc.id,
            beacons: sc.beacons.clone(),
        },
    }
}

/// from http://nghiaho.com/?page_id=671
fn compute_transform(
    sc_from: &Scanner,
    sc_to: &Scanner,
    mbeacons: &Vec<(usize, usize)>,
) -> (Rotation, Pos, Pos) {
    // compute centroids in each basis
    let (mut centroid_from, mut centroid_to) =
        mbeacons
            .iter()
            .fold(([0, 0, 0], [0, 0, 0]), |(cf, ct), (f, t)| {
                let pf = sc_from.beacons[*f];
                let pt = sc_to.beacons[*t];

                (
                    [cf[0] + pf[0], cf[1] + pf[1], cf[2] + pf[2]],
                    [ct[0] + pt[0], ct[1] + pt[1], ct[2] + pt[2]],
                )
            });
    let len = mbeacons.len() as i64;
    centroid_from = [
        centroid_from[0] / len,
        centroid_from[1] / len,
        centroid_from[2] / len,
    ];
    centroid_to = [
        centroid_to[0] / len,
        centroid_to[1] / len,
        centroid_to[2] / len,
    ];

    // compute each point's coordinate relative to centroid
    let (from_points, to_points): (Vec<Pos>, Vec<Pos>) = mbeacons
        .iter()
        .map(|(f, t)| {
            let pf = sc_from.beacons[*f];
            let pt = sc_to.beacons[*t];

            (
                [
                    pf[0] - centroid_from[0],
                    pf[1] - centroid_from[1],
                    pf[2] - centroid_from[2],
                ],
                [
                    pt[0] - centroid_to[0],
                    pt[1] - centroid_to[1],
                    pt[2] - centroid_to[2],
                ],
            )
        })
        .unzip();

    // find optimal rotation
    let rot = compute_rotation(&from_points, &to_points);

    // find translation
    let trans = minus(centroid_to, rot.rotate(centroid_from));

    (rot, trans, centroid_from)
}

fn main() {
    let args: Vec<String> = env::args().collect();
    if args.len() < 2 {
        println!("expecting a file argument");
        process::exit(1);
    }
    let count = 0;
    println!("max magnitude: {}", count);
}

/// Compute transform matrix given a list of matching points
/// There must be at least 3 points
fn transform_matrix(points: [(Pos, Pos); 3]) -> [Pos; 3] {
    let mut res = [[1, 1, 1], [1, 1, 1], [1, 1, 1]];

    res
}

type Matched = (usize, usize, Vec<(usize, usize)>);

fn order_matchings(ms: &Vec<Matched>) -> Vec<Matched> {
    let mut visited: HashSet<usize> = HashSet::new();
    let mut to_visit = vec![];
    let mut edges = vec![];
    to_visit.push(0);

    while !to_visit.is_empty() {
        let v = to_visit.pop().unwrap();
        for m in ms {
            let (f, t, bs) = m;
            if *f == v && !visited.contains(t) {
                edges.push((*f, *t, bs.clone()));
                to_visit.push(*t);
            } else if *t == v && !visited.contains(f) {
                edges.push(invert(m));
                to_visit.push(*f);
            }
        }
        visited.insert(v);
    }

    edges
}

fn invert(m: &Matched) -> Matched {
    (m.1, m.0, m.2.iter().map(|(f, t)| (*t, *f)).collect())
}

fn max_distance(pos: &Vec<(usize, Pos)>) -> u64 {
    let mut maxd = MIN;
    for i in 0..pos.len() {
        for j in i + 1..pos.len() {
            let d = distanceL1(pos[i].1, pos[j].1);
            println!("maxd {}, d {} {} {}", maxd, d, pos[i].0, pos[j].0);
            maxd = maxd.max(d);
        }
    }
    maxd
}

#[cfg(test)]
mod tests {
    use super::*;
    use aoc2021::kruskal::min_spanning_tree;
    use std::collections::HashSet;

    #[test]
    fn can_explode() {
        let sample_scanners = vec![
            Scanner {
                id: 0,
                beacons: vec![
                    [404, -588, -901],
                    [528, -643, 409],
                    [-838, 591, 734],
                    [390, -675, -793],
                    [-537, -823, -458],
                    [-485, -357, 347],
                    [-345, -311, 381],
                    [-661, -816, -575],
                    [-876, 649, 763],
                    [-618, -824, -621],
                    [553, 345, -567],
                    [474, 580, 667],
                    [-447, -329, 318],
                    [-584, 868, -557],
                    [544, -627, -890],
                    [564, 392, -477],
                    [455, 729, 728],
                    [-892, 524, 684],
                    [-689, 845, -530],
                    [423, -701, 434],
                    [7, -33, -71],
                    [630, 319, -379],
                    [443, 580, 662],
                    [-789, 900, -551],
                    [459, -707, 401],
                ],
            },
            Scanner {
                id: 1,
                beacons: vec![
                    [686, 422, 578],
                    [605, 423, 415],
                    [515, 917, -361],
                    [-336, 658, 858],
                    [95, 138, 22],
                    [-476, 619, 847],
                    [-340, -569, -846],
                    [567, -361, 727],
                    [-460, 603, -452],
                    [669, -402, 600],
                    [729, 430, 532],
                    [-500, -761, 534],
                    [-322, 571, 750],
                    [-466, -666, -811],
                    [-429, -592, 574],
                    [-355, 545, -477],
                    [703, -491, -529],
                    [-328, -685, 520],
                    [413, 935, -424],
                    [-391, 539, -444],
                    [586, -435, 557],
                    [-364, -763, -893],
                    [807, -499, -711],
                    [755, -354, -619],
                    [553, 889, -390],
                ],
            },
            Scanner {
                id: 2,
                beacons: vec![
                    [649, 640, 665],
                    [682, -795, 504],
                    [-784, 533, -524],
                    [-644, 584, -595],
                    [-588, -843, 648],
                    [-30, 6, 44],
                    [-674, 560, 763],
                    [500, 723, -460],
                    [609, 671, -379],
                    [-555, -800, 653],
                    [-675, -892, -343],
                    [697, -426, -610],
                    [578, 704, 681],
                    [493, 664, -388],
                    [-671, -858, 530],
                    [-667, 343, 800],
                    [571, -461, -707],
                    [-138, -166, 112],
                    [-889, 563, -600],
                    [646, -828, 498],
                    [640, 759, 510],
                    [-630, 509, 768],
                    [-681, -892, -333],
                    [673, -379, -804],
                    [-742, -814, -386],
                    [577, -820, 562],
                ],
            },
            Scanner {
                id: 3,
                beacons: vec![
                    [-589, 542, 597],
                    [605, -692, 669],
                    [-500, 565, -823],
                    [-660, 373, 557],
                    [-458, -679, -417],
                    [-488, 449, 543],
                    [-626, 468, -788],
                    [338, -750, -386],
                    [528, -832, -391],
                    [562, -778, 733],
                    [-938, -730, 414],
                    [543, 643, -506],
                    [-524, 371, -870],
                    [407, 773, 750],
                    [-104, 29, 83],
                    [378, -903, -323],
                    [-778, -728, 485],
                    [426, 699, 580],
                    [-438, -605, -362],
                    [-469, -447, -387],
                    [509, 732, 623],
                    [647, 635, -688],
                    [-868, -804, 481],
                    [614, -800, 639],
                    [595, 780, -596],
                ],
            },
            Scanner {
                id: 4,
                beacons: vec![
                    [727, 592, 562],
                    [-293, -554, 779],
                    [441, 611, -461],
                    [-714, 465, -776],
                    [-743, 427, -804],
                    [-660, -479, -426],
                    [832, -632, 460],
                    [927, -485, -438],
                    [408, 393, -506],
                    [466, 436, -512],
                    [110, 16, 151],
                    [-258, -428, 682],
                    [-393, 719, 612],
                    [-211, -452, 876],
                    [808, -476, -593],
                    [-575, 615, 604],
                    [-485, 667, 467],
                    [-680, 325, -822],
                    [-627, -443, -432],
                    [872, -547, -609],
                    [833, 512, 582],
                    [807, 604, 487],
                    [839, -516, 451],
                    [891, -625, 532],
                    [-652, -548, -490],
                    [30, -46, -14],
                ],
            },
        ];
        let sc = sample_scanners;
        let mut matchings: Vec<Matched> = compute_matchings(&sc)
            .iter()
            .map(|m| {
                let beacons = compute_matching_beacons(m);
                (m.from, m.to, beacons)
            })
            .filter(|bs| bs.2.len() >= 12)
            .collect();
        matchings.sort();
        println!("{:?}", matchings);
        let mut found_beacons: HashSet<Pos> = HashSet::new();

        // transformations found so far
        let mut xformed = Vec::with_capacity(sc.len());
        xformed.resize(sc.len(), None);
        xformed[0] = Some((ALL_ROTATIONS[0], [0, 0, 0]));

        // scanners to transform
        let mut to_xform: HashSet<usize> = HashSet::new();
        to_xform.insert(0);
        let ordered_matchings = order_matchings(&matchings);
        let mut cur_scanner = sc[0].clone();
        let mut scanners_pos: Vec<(usize, Pos)> = vec![];
        scanners_pos.push((0, [0, 0, 0]));

        println!("matched {:?}", ordered_matchings);
        for (from, to, _) in ordered_matchings {
            if to_xform.contains(&to) {
                continue;
            }

            // (re)compute matchings
            let scans = vec![cur_scanner.clone(), sc[to].clone()];
            let mbeacons = compute_matching_beacons(&compute_matchings(&scans)[0]);

            let (rot, trans, centroid) = compute_transform(&cur_scanner, &sc[to], &mbeacons);
            println!("{} {} {:?} {:?}", from, to, rot, trans);

            // initialise found_beacons for first scanner
            if found_beacons.is_empty() {
                cur_scanner.beacons.iter().enumerate().for_each(|(_i, b)| {
                    found_beacons.insert(*b);
                    ()
                });
            }

            let not_to_add: Vec<usize> = mbeacons.iter().map(|(_, t)| *t).collect();

            for i in 0..sc[to].beacons.len() {
                if !not_to_add.contains(&i) {
                    let pt = sc[to].beacons[i];
                    let p = plus(rot.rotate(pt), trans);
                    found_beacons.insert(p);
                    cur_scanner.beacons.push(p);
                }
            }
            scanners_pos.push((to, plus([1000, 1000, 1000], trans)));
            to_xform.insert(to);
        }

        let mut bec: Vec<Pos> = found_beacons.drain().collect();
        bec.sort();
        println!("{} {:?}", bec.len(), bec);
        println!("scanners: {:?}", scanners_pos);
        println!("max_distance {:?}", max_distance(&scanners_pos));
        assert_eq!(bec.len(), 330);
    }

    #[test]
    fn compute_max_distance() {
        let scanners_pos: Vec<(usize, Pos)> = vec![
            (0, [0, 0, 0]),
            (15, [-202, -596, -600]),
            (19, [35, 40, 1147]),
            (3, [29, 73, 2260]),
            (1, [14, -601, -1669]),
            (23, [-316, -1175, -214]),
            (2, [123, -1831, -99]),
            (4, [-995, -1057, -362]),
            (10, [679, -1646, 20]),
            (9, [755, -1816, -349]),
            (5, [684, -1135, -655]),
            (18, [-90, -1537, -994]),
            (13, [595, -944, -661]),
            (20, [-528, -1736, -827]),
            (24, [-222, -2318, -1239]),
            (17, [245, -1142, 411]),
            (7, [890, -1663, 461]),
            (21, [213, -55, 331]),
            (25, [-50, -1644, 674]),
            (6, [-263, -1040, 258]),
            (16, [795, -533, 626]),
            (8, [1523, -1126, 1307]),
            (14, [1419, -364, 2276]),
            (11, [149, -577, -735]),
            (12, [670, -1024, -1158]),
            (22, [-431, -1425, -935]),
        ];

        println!(
            "max_distance {:?}\n {:?}",
            scanners_pos,
            max_distance(&scanners_pos)
        );
    }
}
